const qs = new URLSearchParams(location.search);
const hlPref = (qs.get('hl') || localStorage.getItem('hl') || '').toLowerCase();
const langGuess = (((navigator.languages||[navigator.language||''])[0]||'').toLowerCase().startsWith('ja') ? 'ja' : 'en');
const hl = (hlPref || langGuess);
const mode = (qs.get('mode') || localStorage.getItem('mode') || 'legal').toLowerCase();
localStorage.setItem('hl', hl);
localStorage.setItem('mode', mode);
function currentSlug(){ const parts = location.pathname.split('/').filter(Boolean); const i = parts.indexOf('legal'); if (i>=0 && parts[i+1]) return parts[i+1]; return 'privacy'; }
const slug = currentSlug();
const src = (lang) => `/legal/${lang}/${slug}/`; // dir URL for GH Pages
const $viewport = document.getElementById('viewport');
async function tryLegacy(){ const map = { 'privacy': '/privacy/tonight/', 'terms': '/terms/tonight/', 'tokusho': '/tokusho/tonight/', 'outbound-data': '/external-data-policy/tonight/' }; const path = map[slug]; if (!path) return null; try{ const r = await fetch(path, { credentials: 'same-origin' }); if (!r.ok) return null; const html = await r.text(); const tpl = document.createElement('template'); tpl.innerHTML = html; const article = tpl.content.querySelector('article,[data-prism-article]'); return article || tpl.content; }catch(e){ return null; } }
async function loadDoc(lang) { try { const res = await fetch(src(lang), { credentials: 'same-origin' }); if (!res.ok) throw new Error('fetch failed: '+res.status); const html = await res.text(); const tpl = document.createElement('template'); tpl.innerHTML = html; const article = tpl.content.querySelector('article,[data-prism-article]'); return article || tpl.content; } catch (e) { const legacy = await tryLegacy(); if (legacy) return legacy; const wrap = document.createElement('section'); wrap.innerHTML = `<p role="alert" style="padding:12px;border:1px solid #f99;background:#fff0f0">Failed to load content. Open JA/EN: <a href="/legal/ja/${slug}/">JA</a> / <a href="/legal/en/${slug}/">EN</a></p>`; return wrap; } }
function mountSingle(article, lang) { if (article.setAttribute) article.setAttribute('lang', lang); $viewport.innerHTML = ''; $viewport.appendChild(article); }
async function mountCompare() { const alt = (hl==='ja'? 'en':'ja'); const [a, b] = await Promise.all([loadDoc(hl), loadDoc(alt)]); if (a.setAttribute) a.setAttribute('lang', hl); if (b.setAttribute) b.setAttribute('lang', alt); const wrap = document.createElement('div'); wrap.className = 'compare'; const left = document.createElement('div'); left.className='pane left'; left.appendChild(a); const right= document.createElement('div'); right.className='pane right'; right.appendChild(b); wrap.append(left,right); $viewport.innerHTML=''; $viewport.appendChild(wrap); const mod = await import('./compare.js'); mod.syncByUniversalId(left, right); }
(async function init(){ try { if (mode === 'compare') { await mountCompare(); } else { const art = await loadDoc(hl); mountSingle(art, hl); if (mode === 'plain') { const mod = await import('./plain.js'); mod.applyPlainMode($viewport); } } } catch (e) { console.error(e); $viewport.innerHTML = `<p role="alert">Failed to load document for slug: ${slug}. Open: <a href="/legal/ja/${slug}/">JA</a> / <a href="/legal/en/${slug}/">EN</a></p>`; } })();
